# OneCX apps - local dev setup

## Before

Make sure that .sh scripts in /scripts directory are executable

- e.g. `-rwxr-xr-x wait-for.sh`
- if they are not executable, use the command `chmod +x <file>`

## Docker compose

The docker compose in this repo currently contains:

Core infra elements:

- `traefik` reverse proxy
- `postgresdb` generic postgresql db
- `keycloak-app` Access and Identity Management Tool (credentials are: admin/admin)
- `wiremock` mock server to make the setup even more minimalistic

Core app elements (optional):

- `tkit-portal-server` Main MS for tkit portal applications, managing and storing informations about Portals and Users
- `apm` MS which manages access and permissions for Portal users

Some extra useful tooling (optional):

- `pgadmin` UI admin for Postgres, login as capgemini@capgemini.com/mysecretpassword
- `data-mgmt` Backend service implementing logic of persisting data into postgres dbs from xls files
- `data-mgmt-ui` UI application to perist data into configured databases from xls files

## Hosts file

In order to expose multiple services on the same port, we use traefik reverse proxy. It will be available via your hosts 80 port, and will route traffik to containers based on hostnames.
Therefore, for each service you want to access, do add an entry to your hosts files Windows: `c:\Windows\System32\drivers\etc\hosts` and Linux / WSL: `/etc/hosts`(wsl hosts file will be autogenerated from windows file when you restart wsl, unless you disabled that behaviour). Sample file (hosts.sample) is in this repo.

## Usage

### How to use it - mocked variant (A)

To run the essential services only and app services mocked execute:

- `./start-essential.sh`

In this mode the IDE is serving real authentication mechanism and hard-coded (see: ./wiremock-init) portal-server responses

### How to use it - with real app services started variant (B)

To initilize the app services execute first:

- `./setup-environment.sh`

Then run the services:

- `docker-compose up -d`

In this mode the IDE is serving real authentication mechanism and real portal and apm server preloaded with test data

## Initial Data

Postgres server is automatically created with the necessary databases.

Keycloak db is populated with the following configuration:

- **Realm** - OneCx
- **Clients** - ping-angular-app-ui
- **User** - onecx
- **Password** - onecx
- **Roles assigned to the user** - [onecx-portal-admin, onecx-portal-user, onecx-admin, tkit-portal-admin]

Automatic import of basic portal data into tkit-portal-server is enabled.

The easiest way to add your own data into databases is to access data-mgmt-ui under `http://data-mgmt-ui:9091` From there, you can create your own database configuration and persist the data in the form of an .xls file that has the appropriate structure and filename prefix.

## App configurations

To configure your local applications to work together with services or mock from this compose, change the corresponding addresses of the dependent services in your local app, using only hostnames of the docker services.

**proxy-conf.json** example:

```json
  "/portal-api": {
    "target": "http://tkit-portal-server",
    "secure": false,
    "pathRewrite": {
      "^/portal-api": ""
    },
    "changeOrigin": true,
    "logLevel": "debug"
  },

```

OR :

```json
  "/portal-api": {
    "target": "http://wiremock/portal-api/",
    "secure": false,
    "pathRewrite": {
      "^/portal-api": ""
    },
    "changeOrigin": true,
    "logLevel": "debug"
  },

```

**env.json** example:

```json
  "KEYCLOAK_REALM": "OneCX",
  "KEYCLOAK_URL": "http://keycloak-app/",
  "KEYCLOAK_CLIENT_ID": "ping-angular-app-ui",
  "TKIT_PORTAL_ID": "ADMIN",
```
